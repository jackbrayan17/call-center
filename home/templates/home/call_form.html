{% extends "base.html" %}
{% block title %}Appel {{ company.name }}{% endblock %}
{% block head_extra %}
    <style>
        .call-layout { display: grid; gap: 1rem; grid-template-columns: 1.15fr 0.85fr; }
        .mic-overlay {
            display: none;
            position: fixed;
        inset: 0;
        background: rgba(8,12,24,0.75);
        backdrop-filter: blur(8px);
        align-items: center;
        justify-content: center;
        z-index: 20;
    }
    .mic-modal {
        background: var(--panel);
        border: 1px solid var(--border);
        border-radius: 18px;
        padding: 1.5rem;
        text-align: center;
        width: min(420px, 90vw);
        box-shadow: 0 20px 60px rgba(0,0,0,0.4);
        animation: pop 260ms ease;
    }
    .mic-icon {
        width: 82px; height: 82px;
        border-radius: 24px;
        background: radial-gradient(circle at 30% 30%, rgba(34,211,238,0.5), rgba(168,85,247,0.6));
        display: grid;
        place-items: center;
        margin: 0 auto 1rem;
        animation: pulse 1.6s infinite;
    }
    @keyframes pulse { 0% { box-shadow: 0 0 0 0 rgba(34,211,238,0.32);} 70%{box-shadow:0 0 0 18px rgba(34,211,238,0);}100%{box-shadow:0 0 0 0 rgba(34,211,238,0);} }
    @keyframes pop { from { scale: 0.95; opacity: 0; } to { scale: 1; opacity: 1; } }
    .call-card { background: rgba(255,255,255,0.02); border: 1px dashed var(--border); border-radius: 14px; padding: 1rem; }
    .control-row { display:flex; gap:0.5rem; flex-wrap: wrap; }
    @media(max-width:900px) { .call-layout { grid-template-columns: 1fr; } }
    .rec-visual {
        position: relative;
        height: 14px;
        background: rgba(255,255,255,0.08);
        border-radius: 999px;
        overflow: hidden;
        margin-top: 0.65rem;
        border: 1px solid rgba(255,255,255,0.08);
    }
    .rec-visual .bar {
        position: absolute;
        inset: 0;
        width: 0%;
        background: linear-gradient(90deg, #22d3ee, #a855f7);
        animation: recFlow 2s linear infinite;
    }
    @keyframes recFlow { from { transform: translateX(-40%);} to { transform: translateX(100%);} }
    .spectrum {
        display: grid;
        grid-template-columns: repeat(24, 1fr);
        gap: 4px;
        align-items: end;
        height: 70px;
        margin-top: 0.6rem;
    }
    .spectrum span {
        width: 100%;
        height: 12px;
        background: linear-gradient(180deg, #22d3ee, #7c3aed);
        border-radius: 8px 8px 2px 2px;
        transition: height 90ms ease;
        box-shadow: 0 4px 12px rgba(34,211,238,0.25);
    }
    .q-section { margin-top: 1rem; padding: 1rem; border-radius: 14px; border: 1px solid var(--border); background: rgba(255,255,255,0.02); }
    .q-title { display:flex; align-items:center; gap:0.5rem; margin:0 0 0.5rem; font-size:1rem; }
    .q-grid { display:grid; gap:0.75rem; grid-template-columns: repeat(auto-fit, minmax(220px,1fr)); }
    .pill-label { display:inline-flex; gap:0.4rem; align-items:center; padding:0.2rem 0.65rem; border-radius:999px; background:rgba(255,255,255,0.06); color:var(--muted); font-size:0.9rem; }
    .q-block { border:1px dashed var(--border); border-radius:12px; padding:0.75rem; background:rgba(255,255,255,0.02); }
    .q-sub { margin:0.2rem 0; color:var(--muted); }
    .q-columns { display:grid; gap:0.5rem; grid-template-columns: repeat(auto-fit, minmax(160px, 1fr)); }
    .muted-note { font-size:0.9rem; color:var(--muted); }
</style>
{% endblock %}
{% block content %}
<section class="panel fade-in">
    <div style="display:flex; justify-content:space-between; align-items:flex-start; gap:1rem; flex-wrap:wrap;">
        <div>
            <p class="pill">Appel s√©curis√©</p>
            <h2 style="margin:0;">{{ company.name }}</h2>
            <p class="muted" style="margin:0;">{{ company.location }} ¬∑ {{ company.activity }}</p>
        </div>
        <a class="btn secondary" href="{% url 'call_list' %}">Retour aux appels</a>
    </div>

    <div class="call-layout" style="margin-top:1.25rem;">
        <div class="call-card">
            <div style="display:flex; align-items:center; gap:0.6rem; justify-content:space-between; flex-wrap:wrap;">
                <h3 style="margin:0;">Informations entreprise</h3>
                <button type="button" id="open-questionnaire" class="btn secondary" style="gap:0.35rem; min-width:auto; padding:0.55rem 0.8rem;">
                    ‚ùì Questionnaire
                </button>
            </div>
            <div class="grid" style="grid-template-columns:repeat(auto-fit, minmax(220px,1fr)); gap:0.75rem; margin-top:0.5rem;">
                <div>
                    <p class="muted">N¬∞</p>
                    <div>{{ company.id }}</div>
                </div>
                <div>
                    <p class="muted">T√©l√©phone</p>
                    <div>{{ company.phone }}</div>
                </div>
                <div>
                    <p class="muted">Produit / fili√®re</p>
                    <div>{{ company.product }}</div>
                </div>
                <div>
                    <p class="muted">Activit√©</p>
                    <div>{{ company.activity }}</div>
                </div>
                <div>
                    <p class="muted">Localisation</p>
                    <div>{{ company.location }}</div>
                </div>
                <div>
                    <p class="muted">R√©gime / Forme</p>
                    <div>{{ company.legal_form }}</div>
                </div>
                <div>
                    <p class="muted">NIU</p>
                    <div>{{ company.niu }}</div>
                </div>
                <div>
                    <p class="muted">Validit√© score</p>
                    <div>{{ company.validity_score }}</div>
                </div>
            </div>
        </div>

        <div class="call-card">
            <div style="display:flex; justify-content:space-between; align-items:center; gap:0.5rem; flex-wrap:wrap;">
                <h3 style="margin:0;">Contr√¥le enregistrement</h3>
                <a href="#" id="skip-record" class="muted">Continuer sans enregistrement vocal</a>
            </div>
            <div class="control-row" style="margin-top:0.75rem;">
                <button class="btn" type="button" id="start-mic">
                    <span id="mic-anim" style="display:inline-flex;align-items:center;gap:0.4rem;">
                        <span class="dot" style="width:10px;height:10px;background:#22d3ee;box-shadow:0 0 10px rgba(34,211,238,0.8);"></span>
                        Lancer le micro
                    </span>
                </button>
                <button class="btn secondary" type="button" id="pause-mic" style="display:none;">Pause</button>
                <button class="btn secondary" type="button" id="resume-mic" style="display:none;">Continuer</button>
            </div>
            <div class="rec-visual">
                <div class="bar" id="rec-bar"></div>
            </div>
            <div class="spectrum" id="rec-spectrum"></div>
            <p class="muted" id="record-status" style="margin-top:0.5rem;">En attente de d√©marrage.</p>
            <div class="glass" style="margin-top:0.8rem;">
                <div style="display:flex; justify-content:space-between; gap:0.75rem; align-items:center; flex-wrap:wrap;">
                    <div>
                        <p class="muted" style="margin:0;">Transcription</p>
                        <small class="muted" id="transcribe-status">En attente d'un enregistrement.</small>
                    </div>
                    <div class="control-row" style="justify-content:flex-end;">
                        <button class="btn secondary" type="button" id="transcribe-btn">Transcrire</button>
                        <button class="btn secondary" type="button" id="copy-transcript" disabled>Copier</button>
                        <button class="btn secondary" type="button" id="download-transcript" disabled>T√©l√©charger</button>
                    </div>
                </div>
                <textarea id="transcript-output" class="input" rows="6" readonly style="margin-top:0.65rem;" placeholder="Le texte transcrit appara√Ætra ici."></textarea>
            </div>
        </div>
    </div>

    <form method="post" style="margin-top:1.5rem;" id="call-form">
        {% csrf_token %}
        {{ form.status_marked_at }}
        {{ form.recording_data }}
        {{ form.recording_started }}
        {{ form.skip_without_rec }}
        {{ form.recording_mime }}
        {{ form.questionnaire_data }}
        <div class="grid" style="gap:1rem; grid-template-columns:repeat(auto-fit, minmax(260px,1fr));">
            <div>
                <label class="muted">Statut num√©ros</label>
                {{ form.status_numero }}
            </div>
            <div id="call-status-wrap" style="display:none;">
                <label class="muted">Statut appel</label>
                {{ form.call_status }}
            </div>
            <div id="presentation-wrap" style="display:none;">
                <label class="muted">Pr√©sentation</label>
                {{ form.presentation_level }}
            </div>
            <div id="libre-wrap" style="display:none;">
                <label class="muted">Questions libres</label>
                {{ form.questions_libres_level }}
            </div>
            <div id="oriente-wrap" style="display:none;">
                <label class="muted">Questions orient√©es</label>
                {{ form.questions_orientees_level }}
            </div>
            <div>
                <label class="muted">Statut enqu√™te</label>
                <input class="input" id="enquete-status" type="text" readonly value="Incomplet">
            </div>
            <div>
                <label class="muted">Date & heure</label>
                <input class="input" id="timestamp" type="text" readonly placeholder="S√©lectionnez un statut">
            </div>
        </div>
        <div style="display:flex; gap:0.75rem; margin-top:1.25rem; flex-wrap:wrap;">
            <button class="btn" type="submit">Valider l'enregistrement</button>
            <button class="btn secondary" type="reset">Recommencer</button>
        </div>
    </form>
</section>

<div class="mic-overlay" id="mic-modal">
    <div class="mic-modal">
        <div class="mic-icon">
            üéôÔ∏è
        </div>
        <h3>Micro en cours d'activation‚Ä¶</h3>
        <p class="muted">Autorisez l'acc√®s √† votre micro sur ce navigateur.</p>
        <div class="control-row" style="justify-content:center; margin-top:1rem;">
            <button class="btn" type="button" id="close-mic">Continuer</button>
        </div>
    </div>
</div>
<div class="mic-overlay" id="questionnaire-modal">
    <div class="mic-modal" style="max-width:960px; text-align:left;">
        <div style="display:flex; justify-content:space-between; align-items:flex-start; gap:0.75rem; flex-wrap:wrap;">
            <div>
                <p class="muted" style="margin:0;">Questionnaire complet</p>
                <h3 style="margin:0;">{{ company.name }}</h3>
            </div>
            <div class="control-row" style="justify-content:flex-end;">
                <span id="questionnaire-status" class="muted"></span>
                <button class="btn secondary" type="button" id="save-questionnaire">Enregistrer</button>
                <button class="btn" type="button" id="close-questionnaire">Fermer</button>
            </div>
        </div>
        <div class="muted" style="max-height:65vh; overflow-y:auto; padding-right:0.5rem;">

            <div class="q-section">
                <div class="q-title"><span class="pill-label">Questionnaire 1</span><strong>Introduction</strong></div>
                <div class="q-grid">
                    <div class="q-block">
                        <p class="q-sub">Est-ce le bon interlocuteur ?</p>
                        <label><input type="radio" name="intro_correct_name" value="yes"> Oui, c'est bien nous</label><br>
                        <label><input type="radio" name="intro_correct_name" value="no"> Non</label>
                        <input class="input" type="text" id="intro_correct_name_text" placeholder="Precisez le bon nom">
                    </div>
                    <div class="q-block">
                        <p class="q-sub">Nom et politesse</p>
                        <input class="input" type="text" id="intro_contact_name" placeholder="Nom de la personne (optionnel)">
                    </div>
                    <div class="q-block">
                        <p class="q-sub">Disponibilite</p>
                        <label><input type="radio" name="intro_available" value="now"> Disponible maintenant</label><br>
                        <label><input type="radio" name="intro_available" value="later"> Rappel plus tard</label>
                        <input class="input" type="text" id="intro_callback_time" placeholder="Heure de rappel">
                        <label style="margin-top:0.4rem; display:block;"><input type="radio" name="intro_available" value="no"> Ne souhaite pas repondre</label>
                    </div>
                </div>
            </div>

            <div class="q-section">
                <div class="q-title"><span class="pill-label">Questionnaire 2</span><strong>Presentation</strong></div>
                <div class="q-grid">
                    <div class="q-block">
                        <p class="q-sub">Produits (choix multiples)</p>
                        <div class="q-columns">
                            <label><input type="checkbox" name="prod_items" value="manioc"> Manioc / gari / baton</label>
                            <label><input type="checkbox" name="prod_items" value="plantain"> Plantain / chips</label>
                            <label><input type="checkbox" name="prod_items" value="fruits_legumes"> Fruits / legumes</label>
                            <label><input type="checkbox" name="prod_items" value="poisson"> Poisson frais / fume</label>
                            <label><input type="checkbox" name="prod_items" value="volaille"> Volaille</label>
                            <label><input type="checkbox" name="prod_items" value="lait"> Lait / fromage / yaourt</label>
                            <label><input type="checkbox" name="prod_items" value="huile_palme"> Huile de palme</label>
                            <label><input type="checkbox" name="prod_items" value="miel"> Miel</label>
                            <label><input type="checkbox" name="prod_items" value="cacao_cafe"> Cacao / cafe</label>
                            <label><input type="checkbox" name="prod_items" value="autre"> Autre</label>
                        </div>
                        <input class="input" type="text" id="prod_other" placeholder="Precisez si autre">
                    </div>
                    <div class="q-block">
                        <p class="q-sub">Anciennete</p>
                        <input class="input" type="text" id="years_activity" placeholder="Ex : 3 ans, moins d'un an">
                    </div>
                    <div class="q-block">
                        <p class="q-sub">Effectif total</p>
                        <input class="input" type="text" id="workers_total" placeholder="Ex : 5 personnes">
                    </div>
                    <div class="q-block">
                        <p class="q-sub">Localisation</p>
                        <input class="input" type="text" id="loc_village" placeholder="Village / Quartier">
                        <input class="input" type="text" id="loc_city" placeholder="Ville la plus proche" style="margin-top:0.35rem;">
                        <input class="input" type="text" id="loc_region" placeholder="Region" style="margin-top:0.35rem;">
                    </div>
                    <div class="q-block">
                        <p class="q-sub">Volume moyen</p>
                        <label><input type="radio" name="volume_unit" value="day"> Par jour</label>
                        <label><input type="radio" name="volume_unit" value="week" style="margin-left:0.75rem;"> Par semaine</label>
                        <label><input type="radio" name="volume_unit" value="month" style="margin-left:0.75rem;"> Par mois</label>
                        <div class="q-columns" style="margin-top:0.35rem;">
                            <input class="input" type="text" id="volume_value" placeholder="Quantite">
                            <select class="input" id="volume_measure">
                                <option value="">Unite</option>
                                <option value="kg">kg</option>
                                <option value="litres">litres</option>
                                <option value="unites">unites</option>
                            </select>
                        </div>
                    </div>
                </div>
            </div>

            <div class="q-section">
                <div class="q-title"><span class="pill-label">Questionnaire 3</span><strong>Questions libres</strong></div>
                <div class="q-grid">
                    <div class="q-block">
                        <p class="q-sub">Marche local</p>
                        <label><input type="radio" name="mlocal_present" value="yes"> Deja present</label><br>
                        <label><input type="radio" name="mlocal_present" value="no"> Pas encore present</label>
                        <textarea class="input" rows="2" id="mlocal_success" placeholder="Si oui : comment avez-vous reussi ?"></textarea>
                        <textarea class="input" rows="2" id="mlocal_blockers" placeholder="Si non : principaux freins ?"></textarea>
                    </div>
                    <div class="q-block">
                        <p class="q-sub">Grossistes / supermarches / hotels</p>
                        <label><input type="radio" name="grossistes_present" value="yes"> Deja present</label><br>
                        <label><input type="radio" name="grossistes_present" value="no"> Pas encore present</label>
                        <textarea class="input" rows="2" id="grossistes_success" placeholder="Si oui : comment avez-vous reussi ?"></textarea>
                        <textarea class="input" rows="2" id="grossistes_blockers" placeholder="Si non : principaux freins ?"></textarea>
                    </div>
                    <div class="q-block">
                        <p class="q-sub">Marche de l Etat</p>
                        <label><input type="radio" name="etat_present" value="yes"> Deja present</label><br>
                        <label><input type="radio" name="etat_present" value="no"> Pas encore present</label>
                        <textarea class="input" rows="2" id="etat_success" placeholder="Si oui : comment avez-vous reussi ?"></textarea>
                        <textarea class="input" rows="2" id="etat_blockers" placeholder="Si non : principaux freins ?"></textarea>
                    </div>
                    <div class="q-block">
                        <p class="q-sub">Marche numerique</p>
                        <label><input type="radio" name="numerique_present" value="yes"> Deja present</label><br>
                        <label><input type="radio" name="numerique_present" value="no"> Pas encore present</label>
                        <textarea class="input" rows="2" id="numerique_success" placeholder="Si oui : comment avez-vous reussi ?"></textarea>
                        <textarea class="input" rows="2" id="numerique_blockers" placeholder="Si non : principaux freins ?"></textarea>
                    </div>
                    <div class="q-block">
                        <p class="q-sub">Export sous-region</p>
                        <label><input type="radio" name="export_reg_present" value="yes"> Deja present</label><br>
                        <label><input type="radio" name="export_reg_present" value="no"> Pas encore present</label>
                        <textarea class="input" rows="2" id="export_reg_success" placeholder="Si oui : comment avez-vous reussi ?"></textarea>
                        <textarea class="input" rows="2" id="export_reg_blockers" placeholder="Si non : principaux freins ?"></textarea>
                    </div>
                    <div class="q-block">
                        <p class="q-sub">Export international</p>
                        <label><input type="radio" name="export_int_present" value="yes"> Deja present</label><br>
                        <label><input type="radio" name="export_int_present" value="no"> Pas encore present</label>
                        <textarea class="input" rows="2" id="export_int_success" placeholder="Si oui : comment avez-vous reussi ?"></textarea>
                        <textarea class="input" rows="2" id="export_int_blockers" placeholder="Si non : principaux freins ?"></textarea>
                    </div>
                </div>
            </div>

            <div class="q-section">
                <div class="q-title"><span class="pill-label">Questionnaire 4</span><strong>Questions orientees</strong></div>
                <p class="muted-note">Si non interesse par de nouveaux marches, ne pas remplir les blocs ci-dessous.</p>
                <div class="q-grid">
                    <div class="q-block">
                        <p class="q-sub">Interet pour d'autres marches</p>
                        <label><input type="radio" name="oriente_interest" value="yes"> Oui</label><br>
                        <label><input type="radio" name="oriente_interest" value="no"> Non (fin du questionnaire)</label>
                    </div>
                </div>
                <div class="q-grid">
                    <div class="q-block">
                        <p class="q-sub"><strong>1. Marche local</strong></p>
                        <label class="muted">Vendre plus au village / petite ville</label>
                        <div>
                            <label><input type="checkbox" name="local_sell_more" value="emplacement"> Je ne sais pas ou m‚Äôinstaller</label><br>
                            <label><input type="checkbox" name="local_sell_more" value="regles"> Jours du marche / regles / prix</label>
                        </div>
                        <label class="muted" style="display:block; margin-top:0.35rem;">Grande ville proche</label>
                        <div>
                            <label><input type="checkbox" name="local_city_barriers" value="stockage"> Pas d‚Äôequipements pour stocker</label><br>
                            <label><input type="checkbox" name="local_city_barriers" value="emballages"> Pas de bons emballages</label><br>
                            <label><input type="checkbox" name="local_city_barriers" value="froid"> Pas de conservation sur la route</label>
                        </div>
                        <label class="muted" style="display:block; margin-top:0.35rem;">Transport</label>
                        <div>
                            <label><input type="checkbox" name="local_transport" value="moyen"> Pas de moyen de transport</label><br>
                            <label><input type="checkbox" name="local_transport" value="cout"> Transport trop cher</label><br>
                            <label><input type="checkbox" name="local_transport" value="quantite"> Pas assez de quantites regulieres</label>
                        </div>
                        <label class="muted" style="display:block; margin-top:0.35rem;">Manque d'argent</label>
                        <div>
                            <label><input type="checkbox" name="local_money" value="petit_materiel"> Petit materiel</label><br>
                            <label><input type="checkbox" name="local_money" value="organisation"> Mieux s‚Äôorganiser</label><br>
                            <label><input type="checkbox" name="local_money" value="produire_plus"> Produire plus</label>
                        </div>
                    </div>
                    <div class="q-block">
                        <p class="q-sub"><strong>2. Grossistes / supermarches / hotels</strong></p>
                        <label class="muted">Je ne connais pas bien</label>
                        <div>
                            <label><input type="checkbox" name="wholesale_knowledge" value="qui"> Qui sont les grossistes</label><br>
                            <label><input type="checkbox" name="wholesale_knowledge" value="conditions"> Leurs conditions</label>
                        </div>
                        <label class="muted" style="display:block; margin-top:0.35rem;">Equipements manquants</label>
                        <div>
                            <label><input type="checkbox" name="wholesale_equipment" value="stockage"> Bon stockage</label><br>
                            <label><input type="checkbox" name="wholesale_equipment" value="emballage"> Bons emballages / etiquettes</label><br>
                            <label><input type="checkbox" name="wholesale_equipment" value="froid"> Chaine du froid</label>
                        </div>
                        <label class="muted" style="display:block; margin-top:0.35rem;">Transport</label>
                        <div>
                            <label><input type="checkbox" name="wholesale_transport" value="moyen"> Pas de moyen regulier</label><br>
                            <label><input type="checkbox" name="wholesale_transport" value="cout"> Transport trop cher</label>
                        </div>
                        <label class="muted" style="display:block; margin-top:0.35rem;">Formations</label>
                        <div>
                            <label><input type="checkbox" name="wholesale_training" value="normes"> Normes qualite / hygiene</label><br>
                            <label><input type="checkbox" name="wholesale_training" value="papiers"> Papiers et demarches</label><br>
                            <label><input type="checkbox" name="wholesale_training" value="marketing"> Marketing / negociation</label>
                        </div>
                        <label class="muted" style="display:block; margin-top:0.35rem;">Financement</label>
                        <div>
                            <label><input type="checkbox" name="wholesale_money" value="equipements"> Equipements pro</label><br>
                            <label><input type="checkbox" name="wholesale_money" value="formations"> Payer les formations</label><br>
                            <label><input type="checkbox" name="wholesale_money" value="developper"> Developper l‚Äôactivite</label><br>
                            <label><input type="checkbox" name="wholesale_money" value="prefinancer"> Prefinancer une commande</label>
                        </div>
                    </div>
                    <div class="q-block">
                        <p class="q-sub"><strong>3. Marche de l'Etat</strong></p>
                        <label class="muted">Je ne connais pas bien</label>
                        <div>
                            <label><input type="checkbox" name="state_knowledge" value="besoins"> Besoins / appels d‚Äôoffres</label><br>
                            <label><input type="checkbox" name="state_knowledge" value="procedures"> Fonctionnement des commandes publiques</label>
                        </div>
                        <label class="muted" style="display:block; margin-top:0.35rem;">Equipements</label>
                        <div>
                            <label><input type="checkbox" name="state_equipment" value="stockage"> Stockage propre</label><br>
                            <label><input type="checkbox" name="state_equipment" value="emballages"> Emballages scelles</label><br>
                            <label><input type="checkbox" name="state_equipment" value="froid"> Conservation (froid)</label>
                        </div>
                        <label class="muted" style="display:block; margin-top:0.35rem;">Transport</label>
                        <div>
                            <label><input type="checkbox" name="state_transport" value="moyen"> Pas de moyen fiable</label><br>
                            <label><input type="checkbox" name="state_transport" value="cout"> Transport trop cher</label>
                        </div>
                        <label class="muted" style="display:block; margin-top:0.35rem;">Formations</label>
                        <div>
                            <label><input type="checkbox" name="state_training" value="normes"> Normes / regles</label><br>
                            <label><input type="checkbox" name="state_training" value="appels_offres"> Repondre aux appels d‚Äôoffres</label><br>
                            <label><input type="checkbox" name="state_training" value="dossier"> Presenter un dossier</label>
                        </div>
                        <label class="muted" style="display:block; margin-top:0.35rem;">Financement</label>
                        <div>
                            <label><input type="checkbox" name="state_money" value="equipements"> Equipements + formations</label><br>
                            <label><input type="checkbox" name="state_money" value="apprendre_en_ligne"> Apprendre appels d‚Äôoffres en ligne</label><br>
                            <label><input type="checkbox" name="state_money" value="administratif"> Demarches administratives</label><br>
                            <label><input type="checkbox" name="state_money" value="developper"> Developper l‚Äôactivite</label><br>
                            <label><input type="checkbox" name="state_money" value="prefinancer"> Avancer l‚Äôargent pour grosse commande</label>
                        </div>
                    </div>
                    <div class="q-block">
                        <p class="q-sub"><strong>4. Marche numerique</strong></p>
                        <label class="muted">Je ne connais pas bien</label>
                        <div>
                            <label><input type="checkbox" name="digital_knowledge" value="opportunites"> Opportunites en ligne</label><br>
                            <label><input type="checkbox" name="digital_knowledge" value="fonctionnement"> Fonctionnement vente en ligne</label>
                        </div>
                        <label class="muted" style="display:block; margin-top:0.35rem;">Equipements</label>
                        <div>
                            <label><input type="checkbox" name="digital_equipment" value="stockage"> Stockage propre</label><br>
                            <label><input type="checkbox" name="digital_equipment" value="emballage"> Bons emballages colis</label><br>
                            <label><input type="checkbox" name="digital_equipment" value="conservation"> Conservation produits sensibles</label>
                        </div>
                        <label class="muted" style="display:block; margin-top:0.35rem;">Livraison</label>
                        <div>
                            <label><input type="checkbox" name="digital_delivery" value="livreur"> Pas de livreur fiable</label><br>
                            <label><input type="checkbox" name="digital_delivery" value="cout"> Frais de livraison chers</label>
                        </div>
                        <label class="muted" style="display:block; margin-top:0.35rem;">Formations</label>
                        <div>
                            <label><input type="checkbox" name="digital_training" value="qualite"> Bases qualite / hygiene / photos</label><br>
                            <label><input type="checkbox" name="digital_training" value="competences"> Competences numeriques</label><br>
                            <label><input type="checkbox" name="digital_training" value="marketing"> Marketing digital</label>
                        </div>
                        <label class="muted" style="display:block; margin-top:0.35rem;">Financement</label>
                        <div>
                            <label><input type="checkbox" name="digital_money" value="telephone"> Telephone + internet</label><br>
                            <label><input type="checkbox" name="digital_money" value="emballages"> Bons emballages / materiel photo</label><br>
                            <label><input type="checkbox" name="digital_money" value="formations"> Formations</label><br>
                            <label><input type="checkbox" name="digital_money" value="publicite"> Publicite payante</label><br>
                            <label><input type="checkbox" name="digital_money" value="developper"> Developper l‚Äôactivite en ligne</label>
                        </div>
                    </div>
                    <div class="q-block">
                        <p class="q-sub"><strong>5. Export sous-region</strong></p>
                        <label class="muted">Je ne connais pas bien</label>
                        <div>
                            <label><input type="checkbox" name="export_reg_knowledge" value="grossistes"> Grossistes / transitaires</label><br>
                            <label><input type="checkbox" name="export_reg_knowledge" value="procedures"> Procedures d‚Äôexport simples</label>
                        </div>
                        <label class="muted" style="display:block; margin-top:0.35rem;">Equipements</label>
                        <div>
                            <label><input type="checkbox" name="export_reg_equipment" value="stockage"> Bon stockage</label><br>
                            <label><input type="checkbox" name="export_reg_equipment" value="emballage"> Emballages solides</label><br>
                            <label><input type="checkbox" name="export_reg_equipment" value="conservation"> Conservation pendant voyage</label>
                        </div>
                        <label class="muted" style="display:block; margin-top:0.35rem;">Transport</label>
                        <div>
                            <label><input type="checkbox" name="export_reg_transport" value="moyen"> Pas de moyen adapte</label><br>
                            <label><input type="checkbox" name="export_reg_transport" value="cout"> Cout transport trop eleve</label>
                        </div>
                        <label class="muted" style="display:block; margin-top:0.35rem;">Formations</label>
                        <div>
                            <label><input type="checkbox" name="export_reg_training" value="regles"> Regles de base export sous-region</label><br>
                            <label><input type="checkbox" name="export_reg_training" value="papiers"> Papiers / douane</label><br>
                            <label><input type="checkbox" name="export_reg_training" value="presentation"> Presentation produits</label>
                        </div>
                        <label class="muted" style="display:block; margin-top:0.35rem;">Financement</label>
                        <div>
                            <label><input type="checkbox" name="export_reg_money" value="equipements"> Equipements</label><br>
                            <label><input type="checkbox" name="export_reg_money" value="formations"> Formations</label><br>
                            <label><input type="checkbox" name="export_reg_money" value="douane"> Procedures douanieres</label><br>
                            <label><input type="checkbox" name="export_reg_money" value="niveau"> Mettre l‚Äôactivite au niveau</label><br>
                            <label><input type="checkbox" name="export_reg_money" value="prefinancer"> Prefinancer commande</label>
                        </div>
                    </div>
                    <div class="q-block">
                        <p class="q-sub"><strong>6. Export international</strong></p>
                        <label class="muted">Je ne connais pas bien</label>
                        <div>
                            <label><input type="checkbox" name="export_int_knowledge" value="acheteurs"> Acheteurs / transitaires internationaux</label><br>
                            <label><input type="checkbox" name="export_int_knowledge" value="procedures"> Procedures d‚Äôexport vers pays developpes</label>
                        </div>
                        <label class="muted" style="display:block; margin-top:0.35rem;">Equipements</label>
                        <div>
                            <label><input type="checkbox" name="export_int_equipment" value="stockage"> Stockage aux normes internationales</label><br>
                            <label><input type="checkbox" name="export_int_equipment" value="emballage"> Emballages renforces</label><br>
                            <label><input type="checkbox" name="export_int_equipment" value="froid"> Chaine du froid pro</label>
                        </div>
                        <label class="muted" style="display:block; margin-top:0.35rem;">Transport & logistique</label>
                        <div>
                            <label><input type="checkbox" name="export_int_transport" value="solution"> Pas de solution adaptee</label><br>
                            <label><input type="checkbox" name="export_int_transport" value="cout"> Couts logistiques eleves</label>
                        </div>
                        <label class="muted" style="display:block; margin-top:0.35rem;">Formations</label>
                        <div>
                            <label><input type="checkbox" name="export_int_training" value="normes"> Normes internationales</label><br>
                            <label><input type="checkbox" name="export_int_training" value="papiers"> Papiers / certificats</label><br>
                            <label><input type="checkbox" name="export_int_training" value="marketing"> Marketing export</label>
                        </div>
                        <label class="muted" style="display:block; margin-top:0.35rem;">Financement</label>
                        <div>
                            <label><input type="checkbox" name="export_int_money" value="equipements"> Equipements / machines</label><br>
                            <label><input type="checkbox" name="export_int_money" value="formations"> Formations normes</label><br>
                            <label><input type="checkbox" name="export_int_money" value="branding"> Marque / packaging</label><br>
                            <label><input type="checkbox" name="export_int_money" value="administratif"> Demarches administratives</label><br>
                            <label><input type="checkbox" name="export_int_money" value="niveau"> Mettre au niveau international</label><br>
                            <label><input type="checkbox" name="export_int_money" value="prefinancer"> Prefinancer commande</label>
                        </div>
                    </div>
                </div>
            </div>

            <div class="q-section">
                <div class="q-title"><span class="pill-label">Questionnaire 5</span><strong>Chiffre d'affaires</strong></div>
                <div class="q-grid">
                    <div class="q-block">
                        <p class="q-sub">Tranche annuelle</p>
                        <label><input type="radio" name="revenue_range" value="<1m"> Moins de 1 million FCFA</label><br>
                        <label><input type="radio" name="revenue_range" value="1-5m"> 1 a 5 millions</label><br>
                        <label><input type="radio" name="revenue_range" value="5-10m"> 5 a 10 millions</label><br>
                        <label><input type="radio" name="revenue_range" value="10-20m"> 10 a 20 millions</label><br>
                        <label><input type="radio" name="revenue_range" value="20-50m"> 20 a 50 millions</label><br>
                        <label><input type="radio" name="revenue_range" value="50-100m"> 50 a 100 millions</label><br>
                        <label><input type="radio" name="revenue_range" value="100m+"> Plus de 100 millions</label><br>
                    </div>
                    <div class="q-block">
                        <p class="q-sub">Montant exact (optionnel)</p>
                        <input class="input" type="text" id="revenue_exact" placeholder="Chiffre d'affaires annuel en FCFA">
                    </div>
                </div>
            </div>

        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/whisper-web@latest/dist/whisper-web.min.js"></script>
<script>
    const statusNumero = document.getElementById("id_status_numero");
    const callStatus = document.getElementById("id_call_status");
    const presentation = document.getElementById("id_presentation_level");
    const libre = document.getElementById("id_questions_libres_level");
    const oriente = document.getElementById("id_questions_orientees_level");
    const timestampField = document.getElementById("timestamp");
    const hiddenTimestamp = document.getElementById("id_status_marked_at");
    const enqueteStatus = document.getElementById("enquete-status");
    const callStatusWrap = document.getElementById("call-status-wrap");
    const presentationWrap = document.getElementById("presentation-wrap");
    const libreWrap = document.getElementById("libre-wrap");
    const orienteWrap = document.getElementById("oriente-wrap");
    const micModal = document.getElementById("mic-modal");
    const questionnaireModal = document.getElementById("questionnaire-modal");
    const questionnaireField = document.getElementById("id_questionnaire_data");
    const questionnaireStatus = document.getElementById("questionnaire-status");
    const saveQuestionnaireBtn = document.getElementById("save-questionnaire");
    if (questionnaireField && !questionnaireField.value) {
        questionnaireField.value = "{}";
    }
    document.getElementById("open-questionnaire").addEventListener("click", () => {
        questionnaireModal.style.display = "flex";
        if (questionnaireStatus) questionnaireStatus.textContent = "";
    });
    document.getElementById("close-questionnaire").addEventListener("click", () => {
        questionnaireModal.style.display = "none";
    });
    const getRadio = (name) => {
        const el = document.querySelector(`input[name="${name}"]:checked`);
        return el ? el.value : "";
    };
    const getChecks = (name) => Array.from(document.querySelectorAll(`input[name="${name}"]:checked`)).map((el) => el.value);
    const getVal = (id) => {
        const el = document.getElementById(id);
        return el ? el.value.trim() : "";
    };
    function collectFreeMarket(code) {
        return {
            present: getRadio(`${code}_present`),
            success: getVal(`${code}_success`),
            blockers: getVal(`${code}_blockers`),
        };
    }
    function collectQuestionnaireData() {
        return {
            intro: {
                correct_name: getRadio("intro_correct_name"),
                correct_name_text: getVal("intro_correct_name_text"),
                contact_name: getVal("intro_contact_name"),
                availability: getRadio("intro_available"),
                callback_time: getVal("intro_callback_time"),
            },
            presentation: {
                products: getChecks("prod_items"),
                product_other: getVal("prod_other"),
                years_activity: getVal("years_activity"),
                workers_total: getVal("workers_total"),
                location: {
                    village: getVal("loc_village"),
                    city: getVal("loc_city"),
                    region: getVal("loc_region"),
                },
                volume: {
                    unit: getRadio("volume_unit"),
                    value: getVal("volume_value"),
                    measure: getVal("volume_measure"),
                },
            },
            markets_open: {
                marche_local: collectFreeMarket("mlocal"),
                grossistes: collectFreeMarket("grossistes"),
                etat: collectFreeMarket("etat"),
                numerique: collectFreeMarket("numerique"),
                export_reg: collectFreeMarket("export_reg"),
                export_int: collectFreeMarket("export_int"),
            },
            oriented: {
                interest: getRadio("oriente_interest"),
                local: {
                    sell_more: getChecks("local_sell_more"),
                    city_barriers: getChecks("local_city_barriers"),
                    transport: getChecks("local_transport"),
                    money: getChecks("local_money"),
                },
                wholesale: {
                    knowledge: getChecks("wholesale_knowledge"),
                    equipment: getChecks("wholesale_equipment"),
                    transport: getChecks("wholesale_transport"),
                    training: getChecks("wholesale_training"),
                    money: getChecks("wholesale_money"),
                },
                state: {
                    knowledge: getChecks("state_knowledge"),
                    equipment: getChecks("state_equipment"),
                    transport: getChecks("state_transport"),
                    training: getChecks("state_training"),
                    money: getChecks("state_money"),
                },
                digital: {
                    knowledge: getChecks("digital_knowledge"),
                    equipment: getChecks("digital_equipment"),
                    delivery: getChecks("digital_delivery"),
                    training: getChecks("digital_training"),
                    money: getChecks("digital_money"),
                },
                export_reg: {
                    knowledge: getChecks("export_reg_knowledge"),
                    equipment: getChecks("export_reg_equipment"),
                    transport: getChecks("export_reg_transport"),
                    training: getChecks("export_reg_training"),
                    money: getChecks("export_reg_money"),
                },
                export_int: {
                    knowledge: getChecks("export_int_knowledge"),
                    equipment: getChecks("export_int_equipment"),
                    transport: getChecks("export_int_transport"),
                    training: getChecks("export_int_training"),
                    money: getChecks("export_int_money"),
                },
            },
            revenue: {
                range: getRadio("revenue_range"),
                exact: getVal("revenue_exact"),
            },
        };
    }
    function syncQuestionnaire() {
        if (!questionnaireField) return;
        const payload = collectQuestionnaireData();
        questionnaireField.value = JSON.stringify(payload);
        if (questionnaireStatus) {
            questionnaireStatus.textContent = "R√©ponses sauvegard√©es dans le formulaire";
        }
    }
    saveQuestionnaireBtn?.addEventListener("click", () => {
        syncQuestionnaire();
        questionnaireModal.style.display = "none";
    });
    const recordStatus = document.getElementById("record-status");
    const recordingData = document.getElementById("id_recording_data");
    const recordingStarted = document.getElementById("id_recording_started");
    const skipWithoutRec = document.getElementById("id_skip_without_rec");
    const resumeBtn = document.getElementById("resume-mic");
    const pauseBtn = document.getElementById("pause-mic");
    const transcribeBtn = document.getElementById("transcribe-btn");
    const transcriptOutput = document.getElementById("transcript-output");
    const copyTranscript = document.getElementById("copy-transcript");
    const downloadTranscript = document.getElementById("download-transcript");
    const transcribeStatus = document.getElementById("transcribe-status");

    function setTimestamp() {
        const now = new Date();
        const iso = now.toISOString();
        hiddenTimestamp.value = iso;
        timestampField.value = now.toLocaleString("fr-FR");
    }

    function updateEnqueteStatus() {
        if (!enqueteStatus) return;
        let statusLabel = "Incomplet";
        if (callStatus.value === "accepted") {
            const levels = [presentation.value, libre.value, oriente.value];
            if (levels.every((v) => v === "complete")) {
                statusLabel = "Complet";
            } else if (levels.some((v) => v === "partial")) {
                statusLabel = "Partiel";
            }
        }
        enqueteStatus.value = statusLabel;
    }

    function blockStatuses(disabled) {
        statusNumero.disabled = disabled;
        callStatus.disabled = disabled;
        presentation.disabled = disabled;
        libre.disabled = disabled;
        oriente.disabled = disabled;
    }

    blockStatuses(true);
    updateEnqueteStatus();

    statusNumero.addEventListener("change", () => {
        setTimestamp();
        if (statusNumero.value === "answered") {
            callStatusWrap.style.display = "block";
        } else {
            callStatusWrap.style.display = "none";
            presentationWrap.style.display = "none";
            libreWrap.style.display = "none";
            orienteWrap.style.display = "none";
            callStatus.value = "";
            presentation.value = "";
            libre.value = "";
            oriente.value = "";
        }
        updateEnqueteStatus();
    });

    callStatus.addEventListener("change", () => {
        const showExtras = callStatus.value === "accepted";
        presentationWrap.style.display = showExtras ? "block" : "none";
        libreWrap.style.display = showExtras ? "block" : "none";
        orienteWrap.style.display = showExtras ? "block" : "none";
        if (!showExtras) {
            presentation.value = "";
            libre.value = "";
            oriente.value = "";
        }
        updateEnqueteStatus();
    });

    [presentation, libre, oriente].forEach((el) => {
        el.addEventListener("change", updateEnqueteStatus);
    });

    let mediaRecorder = null;
    let chunks = [];
    let streamRef = null;
    let recordingReady = false;
    const recBar = document.getElementById("rec-bar");
    const spectrum = document.getElementById("rec-spectrum");
    let audioCtx = null;
    let analyser = null;
    let spectrumId = null;
    let selectedMime = "";
    let formSubmitted = false;
    let lastRecordingBlob = null;
    let liveTranscription = false;
    let liveLoopRunning = false;
    const companyId = {{ company.id }};
    const csrftoken = document.querySelector('input[name=csrfmiddlewaretoken]').value;

    // Build spectrum bars
    if (spectrum && spectrum.children.length === 0) {
        for (let i = 0; i < 24; i++) {
            const bar = document.createElement("span");
            bar.style.height = "12px";
            spectrum.appendChild(bar);
        }
    }

    async function startMic() {
        if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
            recordStatus.textContent = "Micro non support√© par ce navigateur.";
            return;
        }

        const candidates = [
            "audio/mpeg", // mp3
            "audio/mp4;codecs=opus",
            "audio/mp4",
            "audio/webm;codecs=opus",
            "audio/webm",
        ];
        selectedMime = candidates.find((t) => window.MediaRecorder && MediaRecorder.isTypeSupported(t)) || "";
        if (!selectedMime) {
            recordStatus.textContent = "Enregistrement non support√© sur ce navigateur.";
            return;
        }
        try {
            streamRef = await navigator.mediaDevices.getUserMedia({ audio: true });
            mediaRecorder = new MediaRecorder(streamRef, { mimeType: selectedMime });
            chunks = [];
            mediaRecorder.ondataavailable = (e) => {
                if (e.data.size > 0) chunks.push(e.data);
            };
            mediaRecorder.onstop = async () => {
                const blob = new Blob(chunks, { type: "audio/webm" });
                lastRecordingBlob = blob;
                const reader = new FileReader();
                reader.onloadend = () => {
                    recordingData.value = reader.result;
                    document.getElementById("id_recording_mime").value = selectedMime;
                    recordingReady = true;
                };
                reader.readAsDataURL(blob);
                pauseBtn.style.display = "none";
                resumeBtn.style.display = "none";
                recBar.style.width = "0%";
                recBar.style.animation = "none";
                stopSpectrum();
            };
            mediaRecorder.start();
            recordingStarted.value = "true";
            skipWithoutRec.value = "";
            recordStatus.textContent = "Enregistrement en cours...";
            blockStatuses(false);
            toggleButtons("recording");
            recBar.style.width = "100%";
            recBar.style.animation = "recFlow 1.5s linear infinite";
            liveTranscription = true;
            startLiveLoop();

            // spectrum visual
            audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            analyser = audioCtx.createAnalyser();
            analyser.fftSize = 64;
            const source = audioCtx.createMediaStreamSource(streamRef);
            source.connect(analyser);
            animateSpectrum();
        } catch (err) {
            recordStatus.textContent = "Autorisation micro refus√©e.";
        }
    }

    document.getElementById("start-mic").addEventListener("click", () => {
        micModal.style.display = "flex";
        startMic();
    });

    document.getElementById("close-mic").addEventListener("click", () => {
        micModal.style.display = "none";
        toggleButtons("recording");
    });

    pauseBtn.addEventListener("click", () => {
        if (mediaRecorder && mediaRecorder.state === "recording") {
            mediaRecorder.pause();
            recordStatus.textContent = "Enregistrement en pause.";
            toggleButtons("paused");
        }
    });

    resumeBtn.addEventListener("click", () => {
        if (mediaRecorder && mediaRecorder.state === "paused") {
            mediaRecorder.resume();
            recordStatus.textContent = "Enregistrement en cours...";
            toggleButtons("recording");
            recBar.style.animationPlayState = "running";
        }
    });

    document.getElementById("skip-record").addEventListener("click", (e) => {
        e.preventDefault();
        skipWithoutRec.value = "true";
        recordingStarted.value = "";
        blockStatuses(false);
        recordStatus.textContent = "Mode sans enregistrement vocal.";
        recBar.style.width = "0%";
        recBar.style.animation = "none";
        stopSpectrum();
        lastRecordingBlob = null;
        liveTranscription = false;
    });

    document.getElementById("call-form").addEventListener("submit", async (e) => {
        syncQuestionnaire();
        formSubmitted = true;
        if (mediaRecorder && mediaRecorder.state !== "inactive") {
            e.preventDefault();
            mediaRecorder.stop();
            if (streamRef) {
                streamRef.getTracks().forEach((t) => t.stop());
            }
            const waitForData = () => new Promise((resolve) => {
                const check = () => {
                    if (recordingReady || recordingData.value) return resolve();
                    setTimeout(check, 100);
                };
                check();
            });
            await waitForData();
            e.target.submit();
        }
    });

    function toggleButtons(state) {
        if (state === "recording") {
            document.getElementById("start-mic").style.display = "none";
            pauseBtn.style.display = "inline-flex";
            resumeBtn.style.display = "none";
        } else if (state === "paused") {
            document.getElementById("start-mic").style.display = "none";
            pauseBtn.style.display = "none";
            resumeBtn.style.display = "inline-flex";
        } else {
            document.getElementById("start-mic").style.display = "inline-flex";
            pauseBtn.style.display = "none";
            resumeBtn.style.display = "none";
        }
    }

    function resetStatus() {
        if (formSubmitted) return;
        if (recordingData.value || skipWithoutRec.value) return;
        fetch("{% url 'reset_company_status' company.id %}", {
            method: "POST",
            headers: {
                "X-CSRFToken": csrftoken,
            },
            keepalive: true,
        }).catch(() => {});
    }

    window.addEventListener("beforeunload", resetStatus);

    function animateSpectrum() {
        if (!analyser || !spectrum) return;
        const dataArray = new Uint8Array(analyser.frequencyBinCount);
        analyser.getByteFrequencyData(dataArray);
        const bars = spectrum.children;
        for (let i = 0; i < bars.length; i++) {
            const v = dataArray[i] || 0;
            const h = 12 + (v / 255) * 58;
            bars[i].style.height = `${h}px`;
        }
        spectrumId = requestAnimationFrame(animateSpectrum);
    }

    function stopSpectrum() {
        if (spectrumId) cancelAnimationFrame(spectrumId);
        spectrumId = null;
        if (spectrum) {
            Array.from(spectrum.children).forEach((bar) => (bar.style.height = "12px"));
        }
        if (audioCtx) {
            audioCtx.close().catch(() => {});
            audioCtx = null;
            analyser = null;
        }
    }

    // Transcription Whisper Web (exp√©rimental)
    async function ensureBlob() {
        if (lastRecordingBlob) return lastRecordingBlob;
        const dataUrl = recordingData.value;
        if (!dataUrl) return null;
        const parts = dataUrl.split(",");
        if (parts.length < 2) return null;
        const byteString = atob(parts[1]);
        const mimeString = parts[0].split(":")[1].split(";")[0] || "audio/webm";
        const ab = new ArrayBuffer(byteString.length);
        const ia = new Uint8Array(ab);
        for (let i = 0; i < byteString.length; i++) ia[i] = byteString.charCodeAt(i);
        return new Blob([ab], { type: mimeString });
    }

    async function loadWhisper() {
        if (!window.whisperWeb) {
            transcribeStatus.textContent = "Whisper Web non charg√© (r√©seau requis).";
            throw new Error("whisperWeb missing");
        }
        if (window._whisperModel) return window._whisperModel;
        transcribeStatus.textContent = "Chargement du mod√®le (tiny)...";
        const model = await window.whisperWeb.loadModel({ model: "tiny" });
        window._whisperModel = model;
        transcribeStatus.textContent = "Mod√®le charg√©. Pr√™t.";
        return model;
    }

    async function runTranscription() {
        await transcribeBlob();
    }

    transcribeBtn?.addEventListener("click", runTranscription);
    copyTranscript?.addEventListener("click", async () => {
        if (!transcriptOutput.value) return;
        try {
            await navigator.clipboard.writeText(transcriptOutput.value);
            transcribeStatus.textContent = "Transcription copi√©e.";
        } catch {
            transcribeStatus.textContent = "Impossible de copier.";
        }
    });
    downloadTranscript?.addEventListener("click", () => {
        if (!transcriptOutput.value) return;
        const blob = new Blob([transcriptOutput.value], { type: "text/plain" });
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = `transcription_call_${companyId}.txt`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
    });

    async function transcribeBlob(isLive = false) {
        const blob = await ensureBlob();
        if (!blob) {
            if (!isLive) transcribeStatus.textContent = "Aucun enregistrement √† transcrire.";
            return;
        }
        if (!isLive) {
            transcribeBtn.disabled = true;
            transcribeStatus.textContent = "Transcription en cours...";
        } else {
            transcribeStatus.textContent = "Transcription en direct...";
        }
        try {
            const model = await loadWhisper();
            const arrayBuffer = await blob.arrayBuffer();
            const result = await model.transcribe(new Uint8Array(arrayBuffer));
            const text = result?.text || "";
            if (text) {
                transcriptOutput.value = text;
                copyTranscript.disabled = false;
                downloadTranscript.disabled = false;
                transcribeStatus.textContent = isLive ? "Transcription en direct (mise √† jour)..." : "Transcription termin√©e.";
            } else if (!isLive) {
                transcribeStatus.textContent = "Aucun texte d√©tect√©.";
            }
        } catch (err) {
            console.error(err);
            if (!isLive) transcribeStatus.textContent = "√âchec de la transcription.";
        } finally {
            if (!isLive) transcribeBtn.disabled = false;
        }
    }

    async function startLiveLoop() {
        if (liveLoopRunning) return;
        liveLoopRunning = true;
        while (liveTranscription && mediaRecorder && mediaRecorder.state !== "inactive") {
            await transcribeBlob(true);
            await new Promise((res) => setTimeout(res, 5000));
        }
        liveLoopRunning = false;
    }
</script>
{% endblock %}
